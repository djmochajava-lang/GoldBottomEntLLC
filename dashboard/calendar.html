<!-- dashboard/calendar.html â€” Event Calendar -->
<div class="dashboard-page" id="dash-calendar">
  <div class="dashboard-page-header">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:var(--space-sm);">
      <div><h1>Calendar</h1><p class="text-muted">Manage events, bookings, and deadlines.</p></div>
      <button class="btn btn-primary" id="add-event-btn"><i class="fa-solid fa-plus"></i> Add Event</button>
    </div>
  </div>

  <!-- Two-column layout: Calendar + Upcoming -->
  <div style="display:grid;grid-template-columns:1fr 360px;gap:var(--space-lg);margin-top:var(--space-lg);">

    <!-- Left: Calendar grid -->
    <div>
      <div class="card" id="calendar-container">
        <!-- Calendar navigation -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md);">
          <button class="btn btn-ghost btn-sm" id="cal-prev"><i class="fa-solid fa-chevron-left"></i></button>
          <h3 id="cal-month-title" style="font-size:var(--text-lg);font-weight:var(--fw-bold);color:var(--color-text);"></h3>
          <button class="btn btn-ghost btn-sm" id="cal-next"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <!-- Day-of-week headers -->
        <div style="display:grid;grid-template-columns:repeat(7,1fr);text-align:center;margin-bottom:var(--space-xs);">
          <div style="font-size:var(--text-xs);font-weight:var(--fw-semibold);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:var(--space-xs) 0;">Sun</div>
          <div style="font-size:var(--text-xs);font-weight:var(--fw-semibold);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:var(--space-xs) 0;">Mon</div>
          <div style="font-size:var(--text-xs);font-weight:var(--fw-semibold);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:var(--space-xs) 0;">Tue</div>
          <div style="font-size:var(--text-xs);font-weight:var(--fw-semibold);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:var(--space-xs) 0;">Wed</div>
          <div style="font-size:var(--text-xs);font-weight:var(--fw-semibold);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:var(--space-xs) 0;">Thu</div>
          <div style="font-size:var(--text-xs);font-weight:var(--fw-semibold);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:var(--space-xs) 0;">Fri</div>
          <div style="font-size:var(--text-xs);font-weight:var(--fw-semibold);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:var(--space-xs) 0;">Sat</div>
        </div>

        <!-- Calendar day cells grid -->
        <div id="cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;"></div>
      </div>

      <!-- Selected day events -->
      <div class="card" id="cal-day-events" style="margin-top:var(--space-lg);display:none;">
        <h4 id="cal-day-title" style="margin-bottom:var(--space-md);color:var(--color-text);"></h4>
        <div id="cal-day-list"></div>
      </div>
    </div>

    <!-- Right: Upcoming events sidebar -->
    <div class="card" id="upcoming-events" style="align-self:start;">
      <h3 style="font-size:var(--text-lg);font-weight:var(--fw-semibold);color:var(--color-text);margin-bottom:var(--space-md);"><i class="fa-solid fa-clock text-gold" style="margin-right:var(--space-xs);"></i> Upcoming Events</h3>
      <div id="upcoming-list"></div>
    </div>

  </div>

  <!-- Google Calendar Sync Placeholder -->
  <div class="glass-card" style="margin-top:var(--space-lg);">
    <div style="display:flex;align-items:center;gap:var(--space-md);flex-wrap:wrap;">
      <div style="width:48px;height:48px;border-radius:var(--radius-md);background:var(--color-bg-tertiary);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
        <i class="fa-brands fa-google" style="font-size:var(--text-xl);color:var(--color-gold);"></i>
      </div>
      <div style="flex:1;min-width:200px;">
        <h3 style="font-size:var(--text-md);font-weight:var(--fw-semibold);color:var(--color-text);">Google Calendar Sync</h3>
        <p class="text-muted" style="font-size:var(--text-sm);margin-top:2px;">Sync your events with Google Calendar for two-way updates and shared scheduling.</p>
      </div>
      <div>
        <div style="padding:var(--space-md) var(--space-xl);background:var(--color-bg-tertiary);border:1px dashed var(--color-border);border-radius:var(--radius-md);text-align:center;color:var(--color-text-muted);font-size:var(--text-sm);margin-bottom:var(--space-sm);min-width:260px;">
          <i class="fa-solid fa-calendar-plus" style="font-size:var(--text-xl);display:block;margin-bottom:var(--space-xs);"></i>
          Calendar embed placeholder
        </div>
        <button class="btn btn-secondary btn-sm" disabled><i class="fa-brands fa-google"></i> Connect Google Calendar</button>
        <span class="status-pill status-draft" style="margin-left:var(--space-sm);">Not Connected</span>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  if(typeof DataStore==='undefined')return;

  var MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
  var TYPE_COLORS={gig:'#d4a017',meeting:'#58a6ff',studio:'#bc8cff',deadline:'#f85149',travel:'#3fb950'};
  var TYPE_BADGES={gig:'badge-gold',meeting:'badge-info',studio:'badge',deadline:'badge-danger',travel:'badge-success'};

  var currentYear=new Date().getFullYear();
  var currentMonth=new Date().getMonth();
  var selectedDay=null;

  // --- Render Calendar Grid ---
  function renderCalendar(){
    var grid=document.getElementById('cal-grid');
    var title=document.getElementById('cal-month-title');
    if(!grid||!title)return;
    title.textContent=MONTHS[currentMonth]+' '+currentYear;

    var firstDay=new Date(currentYear,currentMonth,1).getDay();
    var daysInMonth=new Date(currentYear,currentMonth+1,0).getDate();
    var daysInPrev=new Date(currentYear,currentMonth,0).getDate();
    var today=new Date();
    var todayStr=today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');

    var events=DataStore.getEvents();
    var monthPrefix=currentYear+'-'+String(currentMonth+1).padStart(2,'0');

    // Build map of events per day
    var dayEvents={};
    events.forEach(function(e){
      if(!e.date)return;
      var d=e.date.substring(0,10);
      if(!dayEvents[d])dayEvents[d]=[];
      dayEvents[d].push(e);
    });

    var html='';
    var totalCells=42; // 6 rows x 7 cols
    var dayNum=1;
    var nextDayNum=1;

    for(var i=0;i<totalCells;i++){
      var cellDate='';
      var displayNum='';
      var isOutside=false;
      var isToday=false;

      if(i<firstDay){
        // Previous month
        var prevNum=daysInPrev-firstDay+i+1;
        displayNum=prevNum;
        isOutside=true;
        var pm=currentMonth===0?12:currentMonth;
        var py=currentMonth===0?currentYear-1:currentYear;
        cellDate=py+'-'+String(pm).padStart(2,'0')+'-'+String(prevNum).padStart(2,'0');
      } else if(dayNum<=daysInMonth){
        // Current month
        displayNum=dayNum;
        cellDate=currentYear+'-'+String(currentMonth+1).padStart(2,'0')+'-'+String(dayNum).padStart(2,'0');
        if(cellDate===todayStr)isToday=true;
        dayNum++;
      } else {
        // Next month
        displayNum=nextDayNum;
        isOutside=true;
        var nm=currentMonth===11?1:currentMonth+2;
        var ny=currentMonth===11?currentYear+1:currentYear;
        cellDate=ny+'-'+String(nm).padStart(2,'0')+'-'+String(nextDayNum).padStart(2,'0');
        nextDayNum++;
      }

      var isSelected=selectedDay===cellDate;
      var borderColor=isToday?'var(--color-gold)':isSelected?'var(--color-border-light)':'transparent';
      var bgColor=isSelected?'var(--color-bg-elevated)':'var(--color-bg-tertiary)';
      var textColor=isOutside?'var(--color-text-muted)':'var(--color-text)';
      var todayShadow=isToday?'box-shadow:0 0 0 2px var(--color-gold);':'';

      html+='<div data-date="'+cellDate+'" class="cal-day-cell" style="padding:var(--space-xs);min-height:60px;border-radius:var(--radius-sm);background:'+bgColor+';border:1px solid '+borderColor+';cursor:pointer;transition:all 150ms ease;'+todayShadow+'">';
      html+='<div style="font-size:var(--text-sm);font-weight:'+(isToday?'var(--fw-bold)':'var(--fw-medium)')+';color:'+textColor+';margin-bottom:2px;">'+displayNum+'</div>';

      // Event dots
      var cellEvents=dayEvents[cellDate]||[];
      if(cellEvents.length>0){
        html+='<div style="display:flex;flex-wrap:wrap;gap:2px;">';
        cellEvents.forEach(function(ev){
          var color=ev.color||TYPE_COLORS[ev.type]||'var(--color-text-muted)';
          html+='<span style="width:6px;height:6px;border-radius:50%;background:'+color+';display:inline-block;" title="'+((ev.title||'').replace(/"/g,'&quot;'))+'"></span>';
        });
        html+='</div>';
      }
      html+='</div>';
    }

    grid.innerHTML=html;

    // Attach click listeners
    var cells=grid.querySelectorAll('.cal-day-cell');
    cells.forEach(function(cell){
      cell.addEventListener('click',function(){
        selectedDay=cell.getAttribute('data-date');
        renderCalendar();
        showDayEvents(selectedDay);
      });
      cell.addEventListener('mouseenter',function(){
        if(cell.getAttribute('data-date')!==selectedDay){
          cell.style.borderColor='var(--color-border-light)';
        }
      });
      cell.addEventListener('mouseleave',function(){
        var d=cell.getAttribute('data-date');
        var isT=(d===todayStr);
        if(d!==selectedDay&&!isT){
          cell.style.borderColor='transparent';
        }
      });
    });
  }

  // --- Show events for selected day ---
  function showDayEvents(dateStr){
    var container=document.getElementById('cal-day-events');
    var titleEl=document.getElementById('cal-day-title');
    var listEl=document.getElementById('cal-day-list');
    if(!container||!titleEl||!listEl)return;

    var events=DataStore.getEvents().filter(function(e){
      return e.date&&e.date.substring(0,10)===dateStr;
    });

    if(typeof Utils!=='undefined'){
      titleEl.textContent='Events for '+Utils.formatDate(dateStr);
    } else {
      titleEl.textContent='Events for '+dateStr;
    }

    if(!events.length){
      container.style.display='block';
      listEl.innerHTML='<p class="text-muted" style="font-size:var(--text-sm);">No events on this day.</p>';
      return;
    }

    container.style.display='block';
    var html='';
    events.forEach(function(ev){
      var time='';
      if(ev.date&&ev.date.length>10){
        var d=new Date(ev.date);
        var h=d.getHours();var m=d.getMinutes();
        var ampm=h>=12?'PM':'AM';h=h%12||12;
        time=h+':'+String(m).padStart(2,'0')+' '+ampm;
      }
      var badgeClass=TYPE_BADGES[ev.type]||'badge';
      html+='<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:var(--space-md);padding:var(--space-sm) 0;border-bottom:1px solid var(--color-border);">';
      html+='<div style="flex:1;">';
      if(time) html+='<span style="font-size:var(--text-xs);color:var(--color-text-muted);margin-right:var(--space-sm);">'+time+'</span>';
      html+='<strong style="color:var(--color-text);font-size:var(--text-sm);">'+ev.title+'</strong>';
      html+=' <span class="badge '+badgeClass+'" style="margin-left:var(--space-xs);">'+(ev.type||'event')+'</span>';
      if(ev.venue) html+='<div style="font-size:var(--text-xs);color:var(--color-text-muted);margin-top:2px;"><i class="fa-solid fa-location-dot"></i> '+ev.venue+'</div>';
      html+='</div>';
      html+='<div class="data-table-actions">';
      html+='<button class="btn btn-ghost btn-sm" onclick="calEditEvent(\''+ev.id+'\')"><i class="fa-solid fa-pen"></i></button>';
      html+='<button class="btn btn-ghost btn-sm text-danger" onclick="calDeleteEvent(\''+ev.id+'\')"><i class="fa-solid fa-trash"></i></button>';
      html+='</div></div>';
    });
    listEl.innerHTML=html;
  }

  // --- Render upcoming events sidebar ---
  function renderUpcoming(){
    var listEl=document.getElementById('upcoming-list');
    if(!listEl)return;

    var now=new Date().toISOString().substring(0,10);
    var events=DataStore.getEvents()
      .filter(function(e){return e.date&&e.date.substring(0,10)>=now;})
      .sort(function(a,b){return a.date.localeCompare(b.date);})
      .slice(0,8);

    if(!events.length){
      listEl.innerHTML='<div class="empty-state" style="padding:var(--space-lg) 0;"><div class="empty-state-icon"><i class="fa-solid fa-calendar-xmark"></i></div><h3 class="empty-state-title" style="font-size:var(--text-sm);">No upcoming events</h3><p class="empty-state-text">Add an event to get started.</p></div>';
      return;
    }

    var html='';
    events.forEach(function(ev){
      var dateDisplay=(typeof Utils!=='undefined')?Utils.formatDate(ev.date):ev.date.substring(0,10);
      var badgeClass=TYPE_BADGES[ev.type]||'badge';
      html+='<div style="padding:var(--space-sm) 0;border-bottom:1px solid var(--color-border);">';
      html+='<div style="display:flex;align-items:center;justify-content:space-between;gap:var(--space-sm);">';
      html+='<div style="flex:1;min-width:0;">';
      html+='<div style="font-size:var(--text-xs);color:var(--color-text-muted);">'+dateDisplay+'</div>';
      html+='<div style="font-size:var(--text-sm);font-weight:var(--fw-medium);color:var(--color-text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+ev.title+'</div>';
      html+='<div style="display:flex;align-items:center;gap:var(--space-xs);margin-top:2px;">';
      html+='<span class="badge '+badgeClass+'">'+(ev.type||'event')+'</span>';
      if(ev.venue) html+='<span style="font-size:11px;color:var(--color-text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+ev.venue+'</span>';
      html+='</div></div>';
      html+='<div class="data-table-actions" style="flex-shrink:0;">';
      html+='<button class="btn btn-ghost btn-sm" onclick="calEditEvent(\''+ev.id+'\')"><i class="fa-solid fa-pen"></i></button>';
      html+='<button class="btn btn-ghost btn-sm text-danger" onclick="calDeleteEvent(\''+ev.id+'\')"><i class="fa-solid fa-trash"></i></button>';
      html+='</div></div></div>';
    });
    listEl.innerHTML=html;
  }

  // --- Add Event ---
  document.getElementById('add-event-btn').addEventListener('click',function(){
    if(typeof Modal==='undefined')return;
    Modal.open({title:'Add Event',size:'lg',
      content:'<form id="modal-form">'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" name="title" required placeholder="e.g. Blues Alley Show" /></div>'+
          '<div class="form-group"><label class="form-label">Type *</label><select class="form-select" name="type" required><option value="">Select...</option><option value="gig">Gig</option><option value="meeting">Meeting</option><option value="studio">Studio Session</option><option value="deadline">Deadline</option><option value="travel">Travel</option></select></div>'+
        '</div>'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">Date *</label><input type="date" class="form-input" name="dateVal" required /></div>'+
          '<div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" name="timeVal" /></div>'+
        '</div>'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">End Date</label><input type="date" class="form-input" name="endDateVal" /></div>'+
          '<div class="form-group"><label class="form-label">End Time</label><input type="time" class="form-input" name="endTimeVal" /></div>'+
        '</div>'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" name="location" placeholder="City, State" /></div>'+
          '<div class="form-group"><label class="form-label">Venue</label><input type="text" class="form-input" name="venue" placeholder="Venue name" /></div>'+
        '</div>'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">Artist</label><input type="text" class="form-input" name="artist" placeholder="Artist or act name" /></div>'+
          '<div class="form-group"><label class="form-label">Color Override</label><input type="color" class="form-input" name="color" value="#d4a017" style="height:40px;padding:4px;" /></div>'+
        '</div>'+
        '<div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" name="description" rows="2" placeholder="Additional details..."></textarea></div>'+
      '</form>',
      saveText:'Add Event',onSave:function(){
        var f=document.getElementById('modal-form');var d={};
        new FormData(f).forEach(function(v,k){d[k]=v;});
        if(!d.title){Toast.error('Event title is required');return;}
        if(!d.dateVal){Toast.error('Event date is required');return;}
        // Build ISO date string
        d.date=d.dateVal+(d.timeVal?'T'+d.timeVal+':00':'T00:00:00');
        if(d.endDateVal) d.endDate=d.endDateVal+(d.endTimeVal?'T'+d.endTimeVal+':00':'T23:59:00');
        // Clean up temp fields
        delete d.dateVal;delete d.timeVal;delete d.endDateVal;delete d.endTimeVal;
        // Default color from type if not overridden
        if(!d.color||d.color==='#d4a017') d.color=TYPE_COLORS[d.type]||'#d4a017';
        DataStore.addEvent(d);Modal.close();Toast.success('Event added: '+d.title);
        renderCalendar();renderUpcoming();
      }
    });
  });

  // --- Edit Event ---
  window.calEditEvent=function(id){
    var ev=DataStore.getEvent(id);if(!ev||typeof Modal==='undefined')return;
    var evDate=ev.date?ev.date.substring(0,10):'';
    var evTime=(ev.date&&ev.date.length>10)?ev.date.substring(11,16):'';
    var evEndDate=ev.endDate?ev.endDate.substring(0,10):'';
    var evEndTime=(ev.endDate&&ev.endDate.length>10)?ev.endDate.substring(11,16):'';
    var typeOpts=['gig','meeting','studio','deadline','travel'];
    var typeHtml='';typeOpts.forEach(function(t){typeHtml+='<option value="'+t+'"'+(ev.type===t?' selected':'')+'>'+t.charAt(0).toUpperCase()+t.slice(1)+'</option>';});

    Modal.open({title:'Edit: '+ev.title,size:'lg',
      content:'<form id="modal-form">'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" name="title" value="'+((ev.title||'').replace(/"/g,'&quot;'))+'" /></div>'+
          '<div class="form-group"><label class="form-label">Type</label><select class="form-select" name="type">'+typeHtml+'</select></div>'+
        '</div>'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" name="dateVal" value="'+evDate+'" /></div>'+
          '<div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" name="timeVal" value="'+evTime+'" /></div>'+
        '</div>'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">End Date</label><input type="date" class="form-input" name="endDateVal" value="'+evEndDate+'" /></div>'+
          '<div class="form-group"><label class="form-label">End Time</label><input type="time" class="form-input" name="endTimeVal" value="'+evEndTime+'" /></div>'+
        '</div>'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" name="location" value="'+((ev.location||'').replace(/"/g,'&quot;'))+'" /></div>'+
          '<div class="form-group"><label class="form-label">Venue</label><input type="text" class="form-input" name="venue" value="'+((ev.venue||'').replace(/"/g,'&quot;'))+'" /></div>'+
        '</div>'+
        '<div class="grid grid-2">'+
          '<div class="form-group"><label class="form-label">Artist</label><input type="text" class="form-input" name="artist" value="'+((ev.artist||'').replace(/"/g,'&quot;'))+'" /></div>'+
          '<div class="form-group"><label class="form-label">Color</label><input type="color" class="form-input" name="color" value="'+(ev.color||'#d4a017')+'" style="height:40px;padding:4px;" /></div>'+
        '</div>'+
        '<div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" name="description" rows="2">'+((ev.description||'').replace(/</g,'&lt;'))+'</textarea></div>'+
      '</form>',
      saveText:'Save',onSave:function(){
        var f=document.getElementById('modal-form');var d={};
        new FormData(f).forEach(function(v,k){d[k]=v;});
        d.date=d.dateVal+(d.timeVal?'T'+d.timeVal+':00':'T00:00:00');
        if(d.endDateVal) d.endDate=d.endDateVal+(d.endTimeVal?'T'+d.endTimeVal+':00':'T23:59:00');
        else d.endDate='';
        delete d.dateVal;delete d.timeVal;delete d.endDateVal;delete d.endTimeVal;
        DataStore.updateEvent(id,d);Modal.close();Toast.success('Event updated');
        renderCalendar();renderUpcoming();
        if(selectedDay) showDayEvents(selectedDay);
      }
    });
  };

  // --- Delete Event ---
  window.calDeleteEvent=function(id){
    var ev=DataStore.getEvent(id);if(!ev)return;
    Modal.confirm('Delete event "'+ev.title+'"?',function(){
      DataStore.deleteEvent(id);Toast.success('Event deleted');
      renderCalendar();renderUpcoming();
      if(selectedDay) showDayEvents(selectedDay);
    });
  };

  // --- Navigation ---
  document.getElementById('cal-prev').addEventListener('click',function(){
    currentMonth--;
    if(currentMonth<0){currentMonth=11;currentYear--;}
    selectedDay=null;
    document.getElementById('cal-day-events').style.display='none';
    renderCalendar();
  });

  document.getElementById('cal-next').addEventListener('click',function(){
    currentMonth++;
    if(currentMonth>11){currentMonth=0;currentYear++;}
    selectedDay=null;
    document.getElementById('cal-day-events').style.display='none';
    renderCalendar();
  });

  // --- Initial render ---
  renderCalendar();
  renderUpcoming();
})();
</script>
