<!-- dashboard/credentials.html — Credentials & Connections (LOCAL-ONLY) -->

<div class="dashboard-page" id="dash-credentials">
  <div class="dashboard-page-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:24px;">
    <div>
      <h1 style="font-size:1.5rem;font-weight:700;color:var(--color-text);margin:0 0 4px;">Credentials &amp; Connections</h1>
      <p style="color:var(--color-text-muted);font-size:0.85rem;margin:0;">Service accounts, passwords, API keys, and connection details.</p>
    </div>
    <button class="btn btn-primary" id="add-credential-btn" style="display:none;padding:8px 18px;border-radius:8px;background:var(--color-gold);color:#000;font-weight:600;font-size:0.85rem;border:none;cursor:pointer;">
      <i class="fa-solid fa-plus"></i> Add Account
    </button>
  </div>

  <!-- Security Warning Banner -->
  <div id="cred-security-banner" style="display:flex;align-items:center;gap:10px;padding:12px 16px;margin-bottom:20px;border-radius:10px;background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.2);">
    <i class="fa-solid fa-shield-halved" style="font-size:1.1rem;color:var(--color-gold);"></i>
    <span style="font-size:0.82rem;color:var(--color-text-secondary);line-height:1.5;">
      <strong style="color:var(--color-gold);">Local-only page.</strong>
      Credentials are stored in your browser's localStorage (unencrypted). This page is only accessible from the home LAN dashboard.
      Replace placeholder values with your actual credentials.
    </span>
  </div>

  <!-- Stats Bar -->
  <div id="cred-stats-bar" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px;"></div>

  <!-- Filter Bar -->
  <div id="cred-filters" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;"></div>

  <!-- Data Table -->
  <div class="card" id="cred-table-container" style="background:rgba(22,33,62,0.6);border:1px solid rgba(255,215,0,0.1);border-radius:12px;padding:0;overflow:hidden;"></div>

  <!-- Blocked message for remote users -->
  <div id="cred-blocked" style="display:none;text-align:center;padding:60px 20px;">
    <i class="fa-solid fa-lock" style="font-size:3rem;color:var(--color-text-muted);margin-bottom:16px;display:block;"></i>
    <h2 style="color:var(--color-text);font-size:1.2rem;margin:0 0 8px;">Local Access Only</h2>
    <p style="color:var(--color-text-muted);font-size:0.9rem;">Credentials are only available on the local dashboard for security.</p>
  </div>
</div>

<script>
(function(){
  'use strict';
  if (typeof DataStore === 'undefined') return;

  var isLocal = (typeof Auth !== 'undefined' && Auth.isLocalDashboard && Auth.isLocalDashboard());

  // Block remote access
  if (!isLocal) {
    document.getElementById('cred-security-banner').style.display = 'none';
    document.getElementById('cred-stats-bar').style.display = 'none';
    document.getElementById('cred-filters').style.display = 'none';
    document.getElementById('cred-table-container').style.display = 'none';
    document.getElementById('cred-blocked').style.display = 'block';
    return;
  }

  // Show add button for local users
  document.getElementById('add-credential-btn').style.display = 'inline-flex';

  var currentFilter = 'all';

  // ── Category Badges ──────────────────────────────────
  var catBadge = {
    'hosting':    { label: 'Hosting',    bg: 'rgba(88,166,255,0.15)',  color: '#58a6ff' },
    'database':   { label: 'Database',   bg: 'rgba(188,140,255,0.15)', color: '#bc8cff' },
    'auth':       { label: 'Auth',       bg: 'rgba(240,136,62,0.15)',  color: '#f0883e' },
    'payments':   { label: 'Payments',   bg: 'rgba(248,81,73,0.15)',   color: '#f85149' },
    'email':      { label: 'Email',      bg: 'rgba(63,185,80,0.15)',   color: '#3fb950' },
    'ecommerce':  { label: 'Ecommerce',  bg: 'rgba(255,215,0,0.15)',   color: '#ffd700' },
    'music':      { label: 'Music',      bg: 'rgba(210,168,255,0.15)', color: '#d2a8ff' },
    'legal':      { label: 'Legal',      bg: 'rgba(255,166,87,0.15)',  color: '#ffa657' },
    'server':     { label: 'Server',     bg: 'rgba(121,192,255,0.15)', color: '#79c0ff' },
  };

  // ── Render Stats ─────────────────────────────────────
  function renderStats() {
    var bar = document.getElementById('cred-stats-bar');
    var all = DataStore.getCredentials();
    var stats = [
      { icon: 'fa-key',         label: 'Total Accounts', value: all.length, color: '#58a6ff' },
      { icon: 'fa-server',      label: 'Hosting',        value: all.filter(function(c) { return c.category === 'hosting' || c.category === 'server'; }).length, color: '#79c0ff' },
      { icon: 'fa-credit-card', label: 'Payments',       value: all.filter(function(c) { return c.category === 'payments' || c.category === 'ecommerce'; }).length, color: '#ffd700' },
      { icon: 'fa-ellipsis',    label: 'Other',          value: all.filter(function(c) { return !['hosting','server','payments','ecommerce'].includes(c.category); }).length, color: '#bc8cff' },
    ];
    bar.innerHTML = stats.map(function(s) {
      return '<div style="background:rgba(22,33,62,0.6);border:1px solid rgba(255,215,0,0.1);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px;">' +
        '<div style="width:36px;height:36px;border-radius:8px;background:' + s.color + '18;display:flex;align-items:center;justify-content:center;">' +
        '<i class="fa-solid ' + s.icon + '" style="color:' + s.color + ';font-size:0.9rem;"></i></div>' +
        '<div><div style="font-size:1.2rem;font-weight:700;color:var(--color-text);">' + s.value + '</div>' +
        '<div style="font-size:0.72rem;color:var(--color-text-muted);">' + s.label + '</div></div></div>';
    }).join('');
  }

  // ── Render Filters ───────────────────────────────────
  function renderFilters() {
    var filterBar = document.getElementById('cred-filters');
    var filters = [
      { key: 'all', label: 'All' },
      { key: 'hosting', label: 'Hosting' },
      { key: 'database', label: 'Database' },
      { key: 'server', label: 'Server' },
      { key: 'payments', label: 'Payments' },
      { key: 'ecommerce', label: 'Ecommerce' },
      { key: 'email', label: 'Email' },
      { key: 'music', label: 'Music' },
    ];
    filterBar.innerHTML = filters.map(function(f) {
      var isActive = f.key === currentFilter;
      return '<button class="filter-btn" data-filter="' + f.key + '" style="' +
        'padding:6px 14px;border-radius:8px;border:1px solid ' + (isActive ? 'var(--color-gold)' : 'var(--color-border)') + ';' +
        'background:' + (isActive ? 'var(--color-gold)' : 'transparent') + ';' +
        'color:' + (isActive ? '#000' : 'var(--color-text-secondary)') + ';' +
        'font-size:0.78rem;font-weight:600;cursor:pointer;transition:all 0.2s;">' +
        f.label + '</button>';
    }).join('');

    filterBar.addEventListener('click', function(e) {
      var btn = e.target.closest('.filter-btn');
      if (!btn) return;
      currentFilter = btn.getAttribute('data-filter');
      renderFilters();
      renderTable();
    });
  }

  // ── Mask / Reveal ────────────────────────────────────
  function maskedValue(val) {
    if (!val || val.startsWith('[')) return '<span style="color:var(--color-text-muted);font-style:italic;">not set</span>';
    return '<span style="color:var(--color-text-muted);">••••••••</span>';
  }

  // ── Render Table ─────────────────────────────────────
  function renderTable() {
    var container = document.getElementById('cred-table-container');
    var data = DataStore.getCredentials();
    if (currentFilter !== 'all') {
      data = data.filter(function(c) { return c.category === currentFilter; });
    }

    if (data.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--color-text-muted);">' +
        '<i class="fa-solid fa-key" style="font-size:2rem;margin-bottom:12px;display:block;"></i>' +
        'No credentials found' + (currentFilter !== 'all' ? ' in this category.' : '.') + '</div>';
      return;
    }

    var html = '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.82rem;">';
    html += '<thead><tr style="border-bottom:1px solid var(--color-border);text-align:left;">';
    html += '<th style="padding:10px 12px;color:var(--color-text-muted);font-weight:600;">Service</th>';
    html += '<th style="padding:10px 12px;color:var(--color-text-muted);font-weight:600;">Category</th>';
    html += '<th style="padding:10px 12px;color:var(--color-text-muted);font-weight:600;">Username</th>';
    html += '<th style="padding:10px 12px;color:var(--color-text-muted);font-weight:600;">Password</th>';
    html += '<th style="padding:10px 12px;color:var(--color-text-muted);font-weight:600;">API Key</th>';
    html += '<th style="padding:10px 12px;color:var(--color-text-muted);font-weight:600;">Login URL</th>';
    html += '<th style="padding:10px 12px;color:var(--color-text-muted);font-weight:600;">Actions</th>';
    html += '</tr></thead><tbody>';

    data.forEach(function(c) {
      var badge = catBadge[c.category] || { label: c.category, bg: 'rgba(139,148,158,0.15)', color: '#8b949e' };
      var esc = typeof Utils !== 'undefined' ? Utils.escapeHtml : function(s) { return s || ''; };

      html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">';
      html += '<td style="padding:10px 12px;color:var(--color-text);font-weight:500;">' + esc(c.name) + '</td>';
      html += '<td style="padding:10px 12px;"><span style="display:inline-block;padding:2px 8px;border-radius:6px;font-size:0.72rem;font-weight:600;background:' + badge.bg + ';color:' + badge.color + ';">' + badge.label + '</span></td>';

      // Username with copy
      html += '<td style="padding:10px 12px;">';
      if (c.username && !c.username.startsWith('[')) {
        html += '<span style="color:var(--color-text-secondary);">' + esc(c.username) + '</span> ';
        html += '<button onclick="copyCredField(\'' + c.id + '\',\'username\')" style="background:none;border:none;cursor:pointer;color:var(--color-text-muted);font-size:0.75rem;" title="Copy"><i class="fa-regular fa-copy"></i></button>';
      } else {
        html += '<span style="color:var(--color-text-muted);font-style:italic;">not set</span>';
      }
      html += '</td>';

      // Password with mask + toggle + copy
      html += '<td style="padding:10px 12px;">';
      html += '<span id="pw-display-' + c.id + '">' + maskedValue(c.password) + '</span> ';
      if (c.password && !c.password.startsWith('[')) {
        html += '<button onclick="togglePassword(\'' + c.id + '\')" style="background:none;border:none;cursor:pointer;color:var(--color-text-muted);font-size:0.75rem;" title="Toggle visibility"><i id="pw-icon-' + c.id + '" class="fa-solid fa-eye"></i></button> ';
        html += '<button onclick="copyCredField(\'' + c.id + '\',\'password\')" style="background:none;border:none;cursor:pointer;color:var(--color-text-muted);font-size:0.75rem;" title="Copy"><i class="fa-regular fa-copy"></i></button>';
      }
      html += '</td>';

      // API Key with mask + toggle + copy
      html += '<td style="padding:10px 12px;">';
      html += '<span id="ak-display-' + c.id + '">' + maskedValue(c.apiKey) + '</span> ';
      if (c.apiKey && !c.apiKey.startsWith('[')) {
        html += '<button onclick="toggleApiKey(\'' + c.id + '\')" style="background:none;border:none;cursor:pointer;color:var(--color-text-muted);font-size:0.75rem;" title="Toggle visibility"><i id="ak-icon-' + c.id + '" class="fa-solid fa-eye"></i></button> ';
        html += '<button onclick="copyCredField(\'' + c.id + '\',\'apiKey\')" style="background:none;border:none;cursor:pointer;color:var(--color-text-muted);font-size:0.75rem;" title="Copy"><i class="fa-regular fa-copy"></i></button>';
      }
      html += '</td>';

      // Login URL
      html += '<td style="padding:10px 12px;">';
      if (c.loginUrl && !c.loginUrl.startsWith('[')) {
        html += '<a href="' + esc(c.loginUrl) + '" target="_blank" rel="noopener" style="color:#58a6ff;font-size:0.78rem;text-decoration:none;">' +
          '<i class="fa-solid fa-arrow-up-right-from-square" style="margin-right:4px;"></i>Open</a>';
      } else {
        html += '<span style="color:var(--color-text-muted);font-style:italic;">not set</span>';
      }
      html += '</td>';

      // Actions
      html += '<td style="padding:10px 12px;">';
      html += '<button onclick="editCredential(\'' + c.id + '\')" style="background:none;border:none;cursor:pointer;color:var(--color-gold);font-size:0.82rem;margin-right:8px;" title="Edit"><i class="fa-solid fa-pen"></i></button>';
      html += '<button onclick="deleteCredential(\'' + c.id + '\')" style="background:none;border:none;cursor:pointer;color:#f85149;font-size:0.82rem;" title="Delete"><i class="fa-solid fa-trash"></i></button>';
      html += '</td>';

      html += '</tr>';
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  // ── Toggle Visibility ────────────────────────────────
  var revealed = {};

  window.togglePassword = function(id) {
    var cred = DataStore.getCredential(id);
    if (!cred) return;
    var display = document.getElementById('pw-display-' + id);
    var icon = document.getElementById('pw-icon-' + id);
    if (!display || !icon) return;
    var key = 'pw-' + id;
    if (revealed[key]) {
      display.innerHTML = maskedValue(cred.password);
      icon.className = 'fa-solid fa-eye';
      revealed[key] = false;
    } else {
      var esc = typeof Utils !== 'undefined' ? Utils.escapeHtml : function(s) { return s || ''; };
      display.innerHTML = '<span style="color:var(--color-text-secondary);font-family:monospace;font-size:0.78rem;">' + esc(cred.password) + '</span>';
      icon.className = 'fa-solid fa-eye-slash';
      revealed[key] = true;
    }
  };

  window.toggleApiKey = function(id) {
    var cred = DataStore.getCredential(id);
    if (!cred) return;
    var display = document.getElementById('ak-display-' + id);
    var icon = document.getElementById('ak-icon-' + id);
    if (!display || !icon) return;
    var key = 'ak-' + id;
    if (revealed[key]) {
      display.innerHTML = maskedValue(cred.apiKey);
      icon.className = 'fa-solid fa-eye';
      revealed[key] = false;
    } else {
      var esc = typeof Utils !== 'undefined' ? Utils.escapeHtml : function(s) { return s || ''; };
      display.innerHTML = '<span style="color:var(--color-text-secondary);font-family:monospace;font-size:0.78rem;">' + esc(cred.apiKey) + '</span>';
      icon.className = 'fa-solid fa-eye-slash';
      revealed[key] = true;
    }
  };

  // ── Copy to Clipboard ────────────────────────────────
  window.copyCredField = function(id, field) {
    var cred = DataStore.getCredential(id);
    if (!cred || !cred[field]) return;
    var text = cred[field];
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function() {
        if (typeof Toast !== 'undefined') Toast.success('Copied to clipboard');
      });
    } else {
      // Fallback for HTTP (non-HTTPS)
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      if (typeof Toast !== 'undefined') Toast.success('Copied to clipboard');
    }
  };

  // ── Form HTML ────────────────────────────────────────
  function credFormHTML(data) {
    var d = data || {};
    return '<form id="modal-form" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">' +
      '<div style="grid-column:1/-1;">' +
        '<label style="font-size:0.78rem;color:var(--color-text-muted);display:block;margin-bottom:4px;">Service Name *</label>' +
        '<input type="text" name="name" value="' + (d.name || '') + '" required ' +
        'style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--color-border);background:var(--color-bg);color:var(--color-text);font-size:0.85rem;" placeholder="e.g. GitHub, Firebase, Stripe">' +
      '</div>' +
      '<div>' +
        '<label style="font-size:0.78rem;color:var(--color-text-muted);display:block;margin-bottom:4px;">Category</label>' +
        '<select name="category" style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--color-border);background:var(--color-bg);color:var(--color-text);font-size:0.85rem;">' +
          '<option value="hosting"' + (d.category === 'hosting' ? ' selected' : '') + '>Hosting</option>' +
          '<option value="database"' + (d.category === 'database' ? ' selected' : '') + '>Database</option>' +
          '<option value="auth"' + (d.category === 'auth' ? ' selected' : '') + '>Auth</option>' +
          '<option value="payments"' + (d.category === 'payments' ? ' selected' : '') + '>Payments</option>' +
          '<option value="email"' + (d.category === 'email' ? ' selected' : '') + '>Email</option>' +
          '<option value="ecommerce"' + (d.category === 'ecommerce' ? ' selected' : '') + '>Ecommerce</option>' +
          '<option value="music"' + (d.category === 'music' ? ' selected' : '') + '>Music</option>' +
          '<option value="legal"' + (d.category === 'legal' ? ' selected' : '') + '>Legal</option>' +
          '<option value="server"' + (d.category === 'server' ? ' selected' : '') + '>Server</option>' +
        '</select>' +
      '</div>' +
      '<div>' +
        '<label style="font-size:0.78rem;color:var(--color-text-muted);display:block;margin-bottom:4px;">Login URL</label>' +
        '<input type="url" name="loginUrl" value="' + (d.loginUrl || '') + '" ' +
        'style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--color-border);background:var(--color-bg);color:var(--color-text);font-size:0.85rem;" placeholder="https://...">' +
      '</div>' +
      '<div>' +
        '<label style="font-size:0.78rem;color:var(--color-text-muted);display:block;margin-bottom:4px;">Username</label>' +
        '<input type="text" name="username" value="' + (d.username || '') + '" autocomplete="off" ' +
        'style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--color-border);background:var(--color-bg);color:var(--color-text);font-size:0.85rem;" placeholder="username or email">' +
      '</div>' +
      '<div>' +
        '<label style="font-size:0.78rem;color:var(--color-text-muted);display:block;margin-bottom:4px;">Password</label>' +
        '<input type="password" name="password" value="' + (d.password || '') + '" autocomplete="off" ' +
        'style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--color-border);background:var(--color-bg);color:var(--color-text);font-size:0.85rem;" placeholder="password">' +
      '</div>' +
      '<div>' +
        '<label style="font-size:0.78rem;color:var(--color-text-muted);display:block;margin-bottom:4px;">API Key / Token</label>' +
        '<input type="password" name="apiKey" value="' + (d.apiKey || '') + '" autocomplete="off" ' +
        'style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--color-border);background:var(--color-bg);color:var(--color-text);font-size:0.85rem;" placeholder="API key or token">' +
      '</div>' +
      '<div style="grid-column:1/-1;">' +
        '<label style="font-size:0.78rem;color:var(--color-text-muted);display:block;margin-bottom:4px;">Notes</label>' +
        '<textarea name="notes" rows="3" ' +
        'style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--color-border);background:var(--color-bg);color:var(--color-text);font-size:0.85rem;resize:vertical;">' + (d.notes || '') + '</textarea>' +
      '</div>' +
    '</form>';
  }

  function collectFormData() {
    var form = document.getElementById('modal-form');
    if (!form) return {};
    var d = {};
    new FormData(form).forEach(function(v, k) { d[k] = v; });
    return d;
  }

  // ── CRUD Handlers ────────────────────────────────────
  document.getElementById('add-credential-btn').addEventListener('click', function() {
    Modal.open({
      title: 'Add Account',
      size: 'lg',
      content: credFormHTML({ category: 'hosting' }),
      saveText: 'Add Account',
      onSave: function() {
        var d = collectFormData();
        if (!d.name) { Toast.error('Service name is required'); return; }
        DataStore.addCredential(d);
        Modal.close();
        Toast.success('Added: ' + d.name);
        renderStats();
        renderTable();
      }
    });
  });

  window.editCredential = function(id) {
    var cred = DataStore.getCredential(id);
    if (!cred) return;
    Modal.open({
      title: 'Edit: ' + cred.name,
      size: 'lg',
      content: credFormHTML(cred),
      saveText: 'Save Changes',
      onSave: function() {
        var d = collectFormData();
        if (!d.name) { Toast.error('Service name is required'); return; }
        DataStore.updateCredential(id, d);
        Modal.close();
        Toast.success('Updated: ' + d.name);
        revealed = {};
        renderStats();
        renderTable();
      }
    });
  };

  window.deleteCredential = function(id) {
    var cred = DataStore.getCredential(id);
    if (!cred) return;
    Modal.confirm('Delete "' + cred.name + '" credentials?', function() {
      DataStore.deleteCredential(id);
      Toast.success('Deleted: ' + cred.name);
      renderStats();
      renderTable();
    });
  };

  // ── Initialize ───────────────────────────────────────
  renderStats();
  renderFilters();
  renderTable();

})();
</script>
