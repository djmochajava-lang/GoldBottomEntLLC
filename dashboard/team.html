<!-- dashboard/team.html — Team Management (Admin Only) -->
<div class="dashboard-page" id="dash-team">
  <div class="dashboard-page-header">
    <div>
      <h1><i class="fa-solid fa-user-shield text-gold"></i> Team Management</h1>
      <p class="text-muted">Manage user access, approvals, and roles.</p>
    </div>
  </div>

  <!-- Metrics Row -->
  <div id="team-metrics" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:var(--space-md);margin-top:var(--space-lg);"></div>

  <!-- Filter Tabs -->
  <div id="team-filters" style="display:flex;gap:var(--space-xs);margin-top:var(--space-lg);flex-wrap:wrap;"></div>

  <!-- User Table Card -->
  <div class="card" id="team-table-container" style="background:var(--color-bg-secondary);border:1px solid var(--color-border);border-radius:var(--radius-lg);padding:var(--space-lg);margin-top:var(--space-md);overflow-x:auto;"></div>
</div>

<script>
(function(){
  /* ======================================================
     Team Management — Firestore-backed admin page
     ====================================================== */

  // Guard: must be admin
  if (typeof Auth === 'undefined' || !Auth.isAdmin()) {
    var container = document.getElementById('team-table-container');
    if (container) {
      container.innerHTML =
        '<div style="text-align:center;padding:var(--space-3xl);color:var(--color-text-muted);">' +
          '<i class="fa-solid fa-lock" style="font-size:48px;margin-bottom:var(--space-md);display:block;"></i>' +
          '<p>Admin access required.</p>' +
        '</div>';
    }
    return;
  }

  var db = Auth._db;
  if (!db) {
    var container = document.getElementById('team-table-container');
    if (container) {
      container.innerHTML =
        '<div style="text-align:center;padding:var(--space-3xl);color:var(--color-text-muted);">' +
          '<i class="fa-solid fa-database" style="font-size:48px;margin-bottom:var(--space-md);display:block;"></i>' +
          '<p>Firestore not available. Team management requires a database connection.</p>' +
        '</div>';
    }
    return;
  }

  var allUsers = [];
  var currentFilter = 'all';

  /* ---- Load Users from Firestore ---- */
  function loadUsers() {
    db.collection('users').get().then(function(snapshot) {
      allUsers = [];
      snapshot.forEach(function(doc) {
        var data = doc.data();
        data.uid = doc.id;
        allUsers.push(data);
      });
      // Sort: pending first, then by registration date
      allUsers.sort(function(a, b) {
        var order = { pending: 0, approved: 1, denied: 2 };
        var oa = order[a.status] !== undefined ? order[a.status] : 3;
        var ob = order[b.status] !== undefined ? order[b.status] : 3;
        if (oa !== ob) return oa - ob;
        // Then newest first
        var ta = a.registeredAt ? (a.registeredAt.toDate ? a.registeredAt.toDate() : new Date(a.registeredAt)) : new Date(0);
        var tb = b.registeredAt ? (b.registeredAt.toDate ? b.registeredAt.toDate() : new Date(b.registeredAt)) : new Date(0);
        return tb - ta;
      });
      renderMetrics();
      renderFilters();
      renderTable();
    }).catch(function(err) {
      console.error('[Team] Failed to load users:', err);
      if (typeof Toast !== 'undefined') Toast.error('Failed to load team data.');
      var c = document.getElementById('team-table-container');
      if (c) {
        c.innerHTML =
          '<div style="text-align:center;padding:var(--space-3xl);color:var(--color-text-muted);">' +
            '<i class="fa-solid fa-triangle-exclamation" style="font-size:48px;margin-bottom:var(--space-md);display:block;color:var(--color-danger);"></i>' +
            '<p>Error loading users. Check Firestore rules and try again.</p>' +
          '</div>';
      }
    });
  }

  /* ---- Metrics ---- */
  function renderMetrics() {
    var c = document.getElementById('team-metrics');
    if (!c) return;

    var total = allUsers.length;
    var approved = allUsers.filter(function(u){ return u.status === 'approved'; }).length;
    var pending = allUsers.filter(function(u){ return u.status === 'pending'; }).length;
    var denied = allUsers.filter(function(u){ return u.status === 'denied'; }).length;
    var admins = allUsers.filter(function(u){ return u.role === 'admin'; }).length;

    var cards = [
      { label: 'Total Users',  value: total,    icon: 'fa-users',        color: '#d4a017' },
      { label: 'Approved',     value: approved,  icon: 'fa-circle-check', color: '#3fb950' },
      { label: 'Pending',      value: pending,   icon: 'fa-clock',        color: '#d29922' },
      { label: 'Admins',       value: admins,    icon: 'fa-user-shield',  color: '#58a6ff' }
    ];

    function hexToRGB(hex) {
      var r = parseInt(hex.slice(1,3),16);
      var g = parseInt(hex.slice(3,5),16);
      var b = parseInt(hex.slice(5,7),16);
      return r + ',' + g + ',' + b;
    }

    c.innerHTML = cards.map(function(card) {
      var rgb = hexToRGB(card.color);
      return '<div class="glass-card" style="background:var(--color-bg-secondary);border:1px solid var(--color-border);border-radius:var(--radius-lg);padding:var(--space-lg);position:relative;overflow:hidden;">' +
        '<div style="position:absolute;top:-10px;right:-10px;width:60px;height:60px;border-radius:50%;background:rgba(' + rgb + ',0.08);"></div>' +
        '<div style="font-size:var(--text-xs);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:var(--space-xs);">' + card.label + '</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--fw-bold);color:var(--color-text);margin-bottom:var(--space-xs);">' + card.value + '</div>' +
        '<i class="fa-solid ' + card.icon + '" style="color:' + card.color + ';font-size:var(--text-lg);"></i>' +
      '</div>';
    }).join('');
  }

  /* ---- Filters ---- */
  function renderFilters() {
    var c = document.getElementById('team-filters');
    if (!c) return;

    var filters = [
      { key: 'all', label: 'All' },
      { key: 'pending', label: 'Pending' },
      { key: 'approved', label: 'Approved' },
      { key: 'denied', label: 'Denied' }
    ];

    var btnStyle = 'padding:6px 16px;border-radius:var(--radius-full);font-size:var(--text-sm);' +
      'font-weight:var(--fw-medium);cursor:pointer;transition:all 150ms ease;border:1px solid;';

    c.innerHTML = filters.map(function(f) {
      var isActive = f.key === currentFilter;
      var activeStyle = isActive
        ? 'background:var(--color-gold);color:#000;border-color:var(--color-gold);'
        : 'background:transparent;color:var(--color-text-secondary);border-color:var(--color-border);';
      return '<button data-filter="' + f.key + '" style="' + btnStyle + activeStyle + '">' + f.label + '</button>';
    }).join('');
  }

  /* ---- User Table ---- */
  function renderTable() {
    var c = document.getElementById('team-table-container');
    if (!c) return;

    var filtered = currentFilter === 'all'
      ? allUsers
      : allUsers.filter(function(u){ return u.status === currentFilter; });

    if (filtered.length === 0) {
      c.innerHTML =
        '<div style="text-align:center;padding:var(--space-3xl);color:var(--color-text-muted);">' +
          '<i class="fa-solid fa-users-slash" style="font-size:36px;margin-bottom:var(--space-md);display:block;"></i>' +
          '<p>No ' + (currentFilter === 'all' ? '' : currentFilter + ' ') + 'users found.</p>' +
        '</div>';
      return;
    }

    var currentUid = Auth._user ? Auth._user.uid : null;

    var html = '<table style="width:100%;border-collapse:collapse;font-size:var(--text-sm);">' +
      '<thead>' +
        '<tr style="border-bottom:1px solid var(--color-border);text-align:left;">' +
          '<th style="padding:var(--space-sm) var(--space-md);color:var(--color-text-muted);font-weight:var(--fw-medium);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.05em;">User</th>' +
          '<th style="padding:var(--space-sm) var(--space-md);color:var(--color-text-muted);font-weight:var(--fw-medium);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.05em;">Status</th>' +
          '<th style="padding:var(--space-sm) var(--space-md);color:var(--color-text-muted);font-weight:var(--fw-medium);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.05em;">Role</th>' +
          '<th style="padding:var(--space-sm) var(--space-md);color:var(--color-text-muted);font-weight:var(--fw-medium);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.05em;">Provider</th>' +
          '<th style="padding:var(--space-sm) var(--space-md);color:var(--color-text-muted);font-weight:var(--fw-medium);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.05em;">Registered</th>' +
          '<th style="padding:var(--space-sm) var(--space-md);color:var(--color-text-muted);font-weight:var(--fw-medium);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.05em;">Last Login</th>' +
          '<th style="padding:var(--space-sm) var(--space-md);color:var(--color-text-muted);font-weight:var(--fw-medium);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.05em;">Actions</th>' +
        '</tr>' +
      '</thead><tbody>';

    filtered.forEach(function(user) {
      var isCurrentUser = user.uid === currentUid;

      // Avatar
      var avatarHTML = user.photoURL
        ? '<img src="' + user.photoURL + '" alt="" style="width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;" />'
        : '<div style="width:32px;height:32px;border-radius:50%;background:var(--color-bg-tertiary);display:flex;align-items:center;justify-content:center;flex-shrink:0;"><i class="fa-solid fa-user" style="font-size:14px;color:var(--color-text-muted);"></i></div>';

      // Display name
      var nameHTML = '<div style="display:flex;align-items:center;gap:var(--space-sm);">' +
        avatarHTML +
        '<div>' +
          '<div style="font-weight:var(--fw-medium);color:var(--color-text);">' + escapeHtml(user.displayName || 'Unknown') + (isCurrentUser ? ' <span style="font-size:var(--text-xs);color:var(--color-gold);">(you)</span>' : '') + '</div>' +
        '</div>' +
      '</div>';

      // Status badge
      var statusColors = {
        approved: { bg: 'rgba(63,185,80,0.12)', color: '#3fb950', icon: 'fa-circle-check' },
        pending:  { bg: 'rgba(210,153,34,0.12)', color: '#d29922', icon: 'fa-clock' },
        denied:   { bg: 'rgba(248,81,73,0.12)', color: '#f85149', icon: 'fa-circle-xmark' }
      };
      var sc = statusColors[user.status] || statusColors.pending;
      var statusHTML = '<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:var(--radius-full);background:' + sc.bg + ';color:' + sc.color + ';font-size:var(--text-xs);font-weight:var(--fw-semibold);">' +
        '<i class="fa-solid ' + sc.icon + '"></i> ' + (user.status || 'pending') +
      '</span>';

      // Role badge
      var role = user.role || 'member';
      var roleHTML = role === 'admin'
        ? '<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:var(--radius-full);background:rgba(212,160,23,0.12);color:#d4a017;font-size:var(--text-xs);font-weight:var(--fw-semibold);"><i class="fa-solid fa-crown"></i> admin</span>'
        : '<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:var(--radius-full);background:rgba(255,255,255,0.06);color:var(--color-text-muted);font-size:var(--text-xs);font-weight:var(--fw-medium);"><i class="fa-solid fa-user"></i> member</span>';

      // Provider icon
      var providerMap = {
        'google.com':    { icon: 'fa-google',    color: '#4285f4', label: 'Google' },
        'apple.com':     { icon: 'fa-apple',     color: '#fff',    label: 'Apple' },
        'microsoft.com': { icon: 'fa-microsoft', color: '#00a4ef', label: 'Microsoft' }
      };
      var prov = providerMap[user.provider] || { icon: 'fa-key', color: 'var(--color-text-muted)', label: user.provider || 'Unknown' };
      var providerHTML = '<span style="display:inline-flex;align-items:center;gap:4px;color:var(--color-text-secondary);font-size:var(--text-xs);" title="' + prov.label + '">' +
        '<i class="fa-brands ' + prov.icon + '" style="color:' + prov.color + ';"></i> ' + prov.label +
      '</span>';

      // Dates
      var registeredStr = formatTimestamp(user.registeredAt);
      var lastLoginStr = timeAgo(user.lastLoginAt);

      // Action buttons
      var btnSmall = 'padding:4px 10px;border-radius:var(--radius-sm);font-size:var(--text-xs);font-weight:var(--fw-medium);cursor:pointer;border:1px solid;transition:all 150ms ease;';
      var actions = '';

      if (user.status === 'pending') {
        actions =
          '<button onclick="window._teamApprove(\'' + user.uid + '\')" style="' + btnSmall + 'background:rgba(63,185,80,0.15);color:#3fb950;border-color:rgba(63,185,80,0.3);" title="Approve"><i class="fa-solid fa-check"></i> Approve</button> ' +
          '<button onclick="window._teamDeny(\'' + user.uid + '\')" style="' + btnSmall + 'background:rgba(248,81,73,0.15);color:#f85149;border-color:rgba(248,81,73,0.3);" title="Deny"><i class="fa-solid fa-xmark"></i> Deny</button>';
      } else if (user.status === 'approved') {
        var newRole = role === 'admin' ? 'member' : 'admin';
        var roleLabel = role === 'admin' ? 'Demote' : 'Promote';
        var roleIcon = role === 'admin' ? 'fa-arrow-down' : 'fa-arrow-up';
        actions =
          '<button onclick="window._teamChangeRole(\'' + user.uid + '\',\'' + newRole + '\')" ' +
            (isCurrentUser ? 'disabled title="Cannot change your own role" ' : '') +
            'style="' + btnSmall + 'background:rgba(88,166,255,0.15);color:#58a6ff;border-color:rgba(88,166,255,0.3);' + (isCurrentUser ? 'opacity:0.4;cursor:not-allowed;' : '') + '">' +
            '<i class="fa-solid ' + roleIcon + '"></i> ' + roleLabel +
          '</button> ' +
          '<button onclick="window._teamDeny(\'' + user.uid + '\')" ' +
            (isCurrentUser ? 'disabled title="Cannot deny yourself" ' : '') +
            'style="' + btnSmall + 'background:rgba(248,81,73,0.15);color:#f85149;border-color:rgba(248,81,73,0.3);' + (isCurrentUser ? 'opacity:0.4;cursor:not-allowed;' : '') + '">' +
            '<i class="fa-solid fa-ban"></i> Revoke' +
          '</button>';
      } else if (user.status === 'denied') {
        actions =
          '<button onclick="window._teamApprove(\'' + user.uid + '\')" style="' + btnSmall + 'background:rgba(63,185,80,0.15);color:#3fb950;border-color:rgba(63,185,80,0.3);" title="Approve"><i class="fa-solid fa-check"></i> Approve</button>';
      }

      html += '<tr style="border-bottom:1px solid var(--color-border);">' +
        '<td style="padding:var(--space-sm) var(--space-md);">' + nameHTML + '</td>' +
        '<td style="padding:var(--space-sm) var(--space-md);">' + statusHTML + '</td>' +
        '<td style="padding:var(--space-sm) var(--space-md);">' + roleHTML + '</td>' +
        '<td style="padding:var(--space-sm) var(--space-md);">' + providerHTML + '</td>' +
        '<td style="padding:var(--space-sm) var(--space-md);color:var(--color-text-secondary);font-size:var(--text-xs);white-space:nowrap;">' + registeredStr + '</td>' +
        '<td style="padding:var(--space-sm) var(--space-md);color:var(--color-text-secondary);font-size:var(--text-xs);white-space:nowrap;">' + lastLoginStr + '</td>' +
        '<td style="padding:var(--space-sm) var(--space-md);white-space:nowrap;">' + actions + '</td>' +
      '</tr>';
    });

    html += '</tbody></table>';
    c.innerHTML = html;
  }

  /* ---- Helpers ---- */
  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatTimestamp(ts) {
    if (!ts) return '—';
    var d = ts.toDate ? ts.toDate() : new Date(ts);
    if (isNaN(d.getTime())) return '—';
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  function timeAgo(ts) {
    if (!ts) return '—';
    var d = ts.toDate ? ts.toDate() : new Date(ts);
    if (isNaN(d.getTime())) return '—';
    var now = new Date();
    var diff = Math.floor((now - d) / 1000);
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
    return formatTimestamp(ts);
  }

  /* ---- Actions ---- */
  window._teamApprove = function(uid) {
    if (typeof Modal !== 'undefined') {
      Modal.confirm('Approve this user for dashboard access?', function() {
        db.collection('users').doc(uid).update({ status: 'approved' }).then(function() {
          if (typeof Toast !== 'undefined') Toast.success('User approved.');
          loadUsers();
        }).catch(function(err) {
          console.error('[Team] Approve failed:', err);
          if (typeof Toast !== 'undefined') Toast.error('Failed to approve user.');
        });
      });
    }
  };

  window._teamDeny = function(uid) {
    if (uid === (Auth._user ? Auth._user.uid : null)) {
      if (typeof Toast !== 'undefined') Toast.error('Cannot revoke your own access.');
      return;
    }
    if (typeof Modal !== 'undefined') {
      Modal.confirm('Deny/revoke access for this user?', function() {
        db.collection('users').doc(uid).update({ status: 'denied', role: 'member' }).then(function() {
          if (typeof Toast !== 'undefined') Toast.success('User access revoked.');
          loadUsers();
        }).catch(function(err) {
          console.error('[Team] Deny failed:', err);
          if (typeof Toast !== 'undefined') Toast.error('Failed to update user.');
        });
      });
    }
  };

  window._teamChangeRole = function(uid, newRole) {
    if (uid === (Auth._user ? Auth._user.uid : null)) {
      if (typeof Toast !== 'undefined') Toast.error('Cannot change your own role.');
      return;
    }
    var action = newRole === 'admin' ? 'Promote this user to admin?' : 'Demote this user to member?';
    if (typeof Modal !== 'undefined') {
      Modal.confirm(action, function() {
        db.collection('users').doc(uid).update({ role: newRole }).then(function() {
          if (typeof Toast !== 'undefined') Toast.success('Role updated to ' + newRole + '.');
          loadUsers();
        }).catch(function(err) {
          console.error('[Team] Role change failed:', err);
          if (typeof Toast !== 'undefined') Toast.error('Failed to change role.');
        });
      });
    }
  };

  /* ---- Filter Click Handler ---- */
  document.getElementById('team-filters').addEventListener('click', function(e) {
    var btn = e.target.closest('button[data-filter]');
    if (!btn) return;
    currentFilter = btn.getAttribute('data-filter');
    renderFilters();
    renderTable();
  });

  /* ---- Initial Load ---- */
  loadUsers();

})();
</script>
</content>
</invoke>